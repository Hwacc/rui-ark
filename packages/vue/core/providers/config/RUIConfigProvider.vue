<script lang="ts">
export interface RUIConfigProps {
  theme?: RUIConfigContext['theme']
  tooltip?: RUIConfigContext['tooltip']
  dialog?: RUIConfigContext['dialog']
  hoverCard?: RUIConfigContext['hover-card']
  popover?: RUIConfigContext['popover']
  menu?: RUIConfigContext['menu']
  iconify?: RUIConfigContext['iconify']
  toasterManager?: ToasterManagerProps
  messager?: MessagerProps
}
</script>

<script setup lang="ts">
import type {
  MessagerExpose,
  MessagerProps,
} from '@rui-ark/vue-core/components/message'
import type {
  ToasterManagerExpose,
  ToasterManagerProps,
} from '@rui-ark/vue-core/components/toast'
import type { RUIConfigContext } from './rui-config-context'
import { addAPIProvider, addCollection, addIcon } from '@iconify/vue'
import { Message, Messager } from '@rui-ark/vue-core/components/message'
import { ToasterManager } from '@rui-ark/vue-core/components/toast'
import { omit } from 'lodash-es'
import { computed, useTemplateRef } from 'vue'
import { ThemeProvider } from '../theme'
import { provideRUIConfigContext } from './rui-config-context'

const props = withDefaults(defineProps<RUIConfigProps>(), {
  theme: () => ({
    skin: undefined,
    size: 'base',
    unstyled: false,
    bordered: true,
  }),
  tooltip: () => ({
    openDelay: 0,
    closeDelay: 0,
    lazyMount: false,
    unmountOnExit: false,
  }),
  hoverCard: () => ({
    openDelay: 0,
    closeDelay: 300,
    lazyMount: true,
    unmountOnExit: true,
  }),
  dialog: () => ({
    lazyMount: true,
    unmountOnExit: true,
  }),
  popover: () => ({
    lazyMount: true,
    unmountOnExit: true,
  }),
  menu: () => ({
    lazyMount: true,
    unmountOnExit: true,
  }),
  select: () => ({
    lazyMount: false,
    unmountOnExit: false,
  }),
  iconify: () => ({
    addIcons: [],
    addCollections: [],
    addAPIProviders: [],
  }),
  toasterManager: () => ({
    disableDefaultToaster: false,
    defaultToasterProps: {},
  }),
  messager: () => ({}),
})

props.iconify?.addIcons?.forEach(([icon, iconifyIcon]) => {
  addIcon(icon, iconifyIcon)
})
props.iconify?.addCollections?.forEach(([collection, provider]) => {
  addCollection(collection, provider)
})
props.iconify?.addAPIProviders?.forEach(([provider, config]) => {
  addAPIProvider(provider, config)
})

const toasterManagerExpose
  = useTemplateRef<ToasterManagerExpose>('toasterManager')
const messagerExpose = useTemplateRef<MessagerExpose>('messager')

provideRUIConfigContext(
  computed(() => ({
    ...omit(props, ['toasterManager', 'messager']),
    toasterManager: toasterManagerExpose.value,
    messager: messagerExpose.value,
  })),
)
</script>

<template>
  <ThemeProvider :value="props.theme">
    <slot />
    <ToasterManager ref="toasterManager" v-bind="props.toasterManager">
      <slot name="toaster" />
    </ToasterManager>
    <Messager
      ref="messager"
      v-slot="{ message }"
      overlap
      v-bind="props.messager"
    >
      <slot name="message">
        <Message :options="message" />
      </slot>
    </Messager>
  </ThemeProvider>
</template>
